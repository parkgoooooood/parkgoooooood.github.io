<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>小卡展示（含管理员系统）</title>
<!-- 引入谷歌字体 -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet" />
<style>
  /* 基础重置 */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Noto Sans SC', sans-serif;
    margin: 20px auto;
    max-width: 960px;
    background: #f9f9fb;
    color: #222;
    text-align: center;
    user-select: none;
  }
  h1 {
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 24px;
    color: #222;
  }

  /* 按钮统一样式 */
  button {
    cursor: pointer;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.25s ease;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    background: #3a86ff;
    color: white;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background: #265fd0;
    box-shadow: 0 6px 14px rgb(38 95 208 / 0.4);
  }
  button:disabled {
    cursor: default;
    background: #a0bfff;
    box-shadow: none;
  }

  /* 管理员登录按钮和头像 */
  #adminLoginBtn, #adminAvatarBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    overflow: hidden;
    background: #3a86ff;
  }
  #adminLoginBtn:hover {
    background: #1a4fbf;
  }
  #adminAvatarBtn {
    display: none;
    border: none;
  }
  #adminAvatarBtn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
  }

  /* 管理员面板 */
  #adminPanel {
    margin: 0 auto 32px;
    padding: 20px 25px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 6px 20px rgb(0 0 0 / 0.1);
    max-width: 620px;
    text-align: left;
    display: none;
  }
  #adminPanel h2 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.5rem;
    color: #333;
  }
  #adminPanel label {
    font-weight: 600;
    margin-right: 8px;
    color: #555;
  }
  #adminPanel select, #adminPanel input[type="file"] {
    font-size: 15px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1.8px solid #ccc;
    outline-offset: 2px;
    outline-color: transparent;
    transition: outline-color 0.25s ease;
  }
  #adminPanel select:focus, #adminPanel input[type="file"]:focus {
    outline-color: #3a86ff;
  }
  #uploadBtn {
    margin-left: 10px;
  }
  #deleteAllBtn {
    background-color: #e63946;
    margin-left: 10px;
  }
  #deleteAllBtn:hover {
    background-color: #b72c34;
  }
  #logoutBtn {
    background-color: #f4a261;
    margin-left: 10px;
  }
  #logoutBtn:hover {
    background-color: #ca7f46;
  }

  /* 分类筛选和搜索 */
  .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  #categorySelect {
    font-size: 16px;
    padding: 8px 14px;
    border-radius: 10px;
    border: 1.8px solid #bbb;
    outline-offset: 2px;
    outline-color: transparent;
    transition: outline-color 0.25s ease;
    min-width: 180px;
  }
  #categorySelect:focus {
    outline-color: #3a86ff;
  }
  #searchInput {
    padding: 8px 14px;
    font-size: 16px;
    border-radius: 10px;
    border: 1.8px solid #bbb;
    outline-offset: 2px;
    outline-color: transparent;
    min-width: 200px;
    transition: outline-color 0.25s ease;
  }
  #searchInput:focus {
    outline-color: #3a86ff;
  }

  /* 卡片容器 */
  .grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
  }

  /* 卡片样式 */
  .card {
    position: relative;
    width: 140px;
    height: 170px;
    border-radius: 16px;
    background: linear-gradient(145deg, #ffffff, #d1d9e6);
    box-shadow: 5px 5px 10px #bec8d9, -5px -5px 10px #ffffff;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .card:hover {
    transform: scale(1.08);
    box-shadow: 8px 8px 16px #b0c0e3, -8px -8px 16px #f0f6ff;
  }
  .card img {
    width: 100%;
    height: 130px;
    object-fit: cover;
    flex-shrink: 0;
    border-bottom-left-radius: 16px;
    border-bottom-right-radius: 16px;
  }
  .delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(230, 46, 46, 0.9);
    border-radius: 50%;
    width: 26px;
    height: 26px;
    border: none;
    color: white;
    font-weight: 900;
    font-size: 18px;
    line-height: 24px;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 0 6px rgba(255, 0, 0, 0.7);
    transition: background 0.3s ease;
    z-index: 10;
  }
  .delete-btn:hover {
    background: rgba(230, 46, 46, 1);
    box-shadow: 0 0 10px rgba(255, 0, 0, 0.9);
  }

  /* 名称显示 */
  .card-name {
    flex-grow: 1;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    color: #3a3a3a;
    padding: 6px 8px 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    user-select: text;
  }
  .card-name[contenteditable="true"] {
    outline: 2px solid #3a86ff;
    border-radius: 4px;
    cursor: text;
  }

  /* 高亮关键词 */
  .highlight {
    background-color: #fffa8b;
  }

  /* 弹窗样式 */
  #modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.75);
    justify-content: center;
    align-items: center;
    z-index: 9999;
    user-select: none;
  }
  #modal img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 14px;
    box-shadow: 0 0 24px 6px rgba(255,255,255,0.3);
    pointer-events: none;
  }
  #modal .arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: #eee;
    font-size: 60px;
    cursor: pointer;
    user-select: none;
    padding: 0 16px;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    transition: background 0.3s ease;
  }
  #modal .arrow:hover {
    background: rgba(0,0,0,0.6);
  }
  #modal .arrow-left {
    left: 20px;
  }
  #modal .arrow-right {
    right: 20px;
  }
  #modal .close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 28px;
    color: #eee;
    cursor: pointer;
    user-select: none;
  }
  #modal .close-btn:hover {
    color: #fff;
  }

  /* 登录面板 */
  #loginPanel {
    margin-bottom: 24px;
  }
  #loginPanel input {
    font-size: 16px;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1.8px solid #ccc;
    outline-offset: 2px;
    outline-color: transparent;
    width: 180px;
    margin-right: 10px;
    transition: outline-color 0.25s ease;
  }
  #loginPanel input:focus {
    outline-color: #3a86ff;
  }

</style>
</head>
<body>
<h1>小卡展示（含管理员系统）</h1>

<!-- 管理员登录按钮 -->
<button id="adminLoginBtn" title="管理员登录">登录</button>

<!-- 管理员头像按钮（登录后显示） -->
<button id="adminAvatarBtn" title="管理员菜单" aria-haspopup="true" aria-expanded="false" aria-label="管理员菜单">
  <img src="" alt="管理员头像" />
</button>

<!-- 登录面板 -->
<div id="loginPanel" style="display:none; text-align:center; margin-bottom: 24px;">
  <input type="text" id="adminUser" placeholder="用户名" autocomplete="username" />
  <input type="password" id="adminPass" placeholder="密码" autocomplete="current-password" />
  <button id="loginSubmitBtn">登录</button>
</div>

<!-- 管理员面板 -->
<div id="adminPanel" role="region" aria-label="管理员面板">
  <h2>管理员面板</h2>
  <label for="categorySelect">选择分类：</label>
  <select id="categorySelect" aria-controls="cardGrid" aria-label="选择卡片分类">
    <option value="all">全部分类</option>
  </select>
  <input type="file" id="uploadInput" accept="image/*" multiple aria-label="上传图片" />
  <button id="uploadBtn">上传图片</button>
  <button id="deleteAllBtn" title="删除当前分类所有卡片">删除当前分类所有</button>
  <button id="logoutBtn">退出登录</button>
</div>

<!-- 搜索框 -->
<div class="controls" style="margin-bottom: 16px;">
  <input id="searchInput" type="text" placeholder="搜索卡片名称..." aria-label="搜索卡片名称" />
</div>

<!-- 卡片展示区 -->
<div id="cardGrid" class="grid" role="list" aria-live="polite" aria-atomic="true" aria-relevant="additions removals"></div>

<!-- 大图弹窗 -->
<div id="modal" role="dialog" aria-modal="true" aria-label="图片预览">
  <span class="arrow arrow-left" role="button" tabindex="0" aria-label="上一张图片">&#10094;</span>
  <img src="" alt="卡片大图" />
  <span class="arrow arrow-right" role="button" tabindex="0" aria-label="下一张图片">&#10095;</span>
  <span class="close-btn" role="button" tabindex="0" aria-label="关闭弹窗">&times;</span>
</div>

<script>
  // --- 管理员账户配置 ---
  const ADMIN_USERNAME = 'admin';
  const ADMIN_PASSWORD = '123456';

  // --- 运行时变量 ---
  let isAdmin = false;
  let categories = ['all'];
  let allCards = []; // 存储所有卡片，格式：{id, name, category, imgData}
  let currentCategory = 'all';
  let currentCategoryCards = [];
  let searchKeyword = '';
  let currentIndex = 0;

  // 页面元素
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminAvatarBtn = document.getElementById('adminAvatarBtn');
  const loginPanel = document.getElementById('loginPanel');
  const loginSubmitBtn = document.getElementById('loginSubmitBtn');
  const adminUserInput = document.getElementById('adminUser');
  const adminPassInput = document.getElementById('adminPass');

  const adminPanel = document.getElementById('adminPanel');
  const categorySelect = document.getElementById('categorySelect');
  const uploadInput = document.getElementById('uploadInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const deleteAllBtn = document.getElementById('deleteAllBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const searchInput = document.getElementById('searchInput');
  const cardGrid = document.getElementById('cardGrid');

  const modal = document.getElementById('modal');
  const modalImg = modal.querySelector('img');
  const modalCloseBtn = modal.querySelector('.close-btn');
  const modalLeftArrow = modal.querySelector('.arrow-left');
  const modalRightArrow = modal.querySelector('.arrow-right');

  // --------------------
  // 登录/登出相关
  function showLoginPanel(show) {
    loginPanel.style.display = show ? 'block' : 'none';
    adminLoginBtn.style.display = show ? 'none' : 'inline-block';
    adminAvatarBtn.style.display = 'none';
    adminPanel.style.display = 'none';
  }

  adminLoginBtn.addEventListener('click', () => {
    showLoginPanel(true);
  });

  loginSubmitBtn.addEventListener('click', () => {
    const user = adminUserInput.value.trim();
    const pass = adminPassInput.value.trim();
    if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
      isAdmin = true;
      showLoginPanel(false);
      adminAvatarBtn.style.display = 'inline-block';
      adminAvatarBtn.querySelector('img').src = 'https://i.pravatar.cc/40?u=admin'; // 管理员头像示例
      adminLoginBtn.style.display = 'none';
      adminPanel.style.display = 'block';
      loadAndRenderCategories();
      loadAndRenderCards();
    } else {
      alert('用户名或密码错误');
    }
  });

  logoutBtn.addEventListener('click', () => {
    if(confirm('确定退出登录吗？')) {
      isAdmin = false;
      showLoginPanel(false);
      adminLoginBtn.style.display = 'inline-block';
      adminAvatarBtn.style.display = 'none';
      adminPanel.style.display = 'none';
      clearInputsAndData();
      loadAndRenderCards();
    }
  });

  adminAvatarBtn.addEventListener('click', () => {
    if (adminPanel.style.display === 'block') {
      adminPanel.style.display = 'none';
      adminAvatarBtn.setAttribute('aria-expanded', 'false');
    } else {
      adminPanel.style.display = 'block';
      adminAvatarBtn.setAttribute('aria-expanded', 'true');
    }
  });

  function clearInputsAndData() {
    adminUserInput.value = '';
    adminPassInput.value = '';
    categories = ['all'];
    currentCategory = 'all';
    allCards = [];
  }

  // --------------------
  // 数据存储与加载（使用 localStorage 模拟，真实项目建议后端或 IndexedDB）
  // key 格式： cards-分类名，示例：cards-all
  function saveCards() {
    categories.forEach(cat => {
      const cards = allCards.filter(c => c.category === cat);
      localStorage.setItem(`cards-${cat}`, JSON.stringify(cards));
    });
  }
  function loadCardsFromStorage() {
    let loaded = false;
    categories.forEach(cat => {
      const data = localStorage.getItem(`cards-${cat}`);
      if(data) {
        const cards = JSON.parse(data);
        cards.forEach(c => {
          if(!allCards.find(ac => ac.id === c.id)) {
            allCards.push(c);
          }
        });
        loaded = true;
      }
    });
    return loaded;
  }

  // --------------------
  // 分类管理
  function loadAndRenderCategories() {
    // 从所有卡片中读取分类
    const cats = new Set(['all']);
    allCards.forEach(c => {
      if (c.category && c.category.trim() !== '') cats.add(c.category.trim());
    });
    categories = Array.from(cats);

    // 清空并渲染分类选择框
    categorySelect.innerHTML = '';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat === 'all' ? '全部分类' : cat;
      categorySelect.appendChild(opt);
    });

    // 默认选择全部分类
    currentCategory = 'all';
    categorySelect.value = 'all';
  }

  categorySelect.addEventListener('change', () => {
    currentCategory = categorySelect.value;
    loadAndRenderCards();
  });

  // --------------------
  // 卡片渲染
  function highlightKeyword(text, keyword) {
    if (!keyword) return text;
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
  }

  function renderCards(cards) {
    const grid = cardGrid;
    grid.innerHTML = '';
    cards.forEach((card) => {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.setAttribute('tabindex', '0');
      cardDiv.setAttribute('role', 'group');
      cardDiv.setAttribute('aria-label', `卡片：${card.name || '未命名'}`);

      // 图片
      const img = document.createElement('img');
      img.src = card.imgData;
      img.alt = card.name || '小卡图片';
      img.loading = 'lazy';

      // 图片点击大图预览
      img.addEventListener('click', () => {
        currentCategoryCards = currentCategoryCards.length ? currentCategoryCards : [];
        currentIndex = currentCategoryCards.findIndex(c => c.id === card.id);
        if (currentIndex === -1) currentIndex = 0;
        openModal(currentIndex);
      });

      cardDiv.appendChild(img);

      // 删除按钮（管理员才显示）
      if(isAdmin) {
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.title = '删除此卡片';
        delBtn.setAttribute('aria-label', '删除此卡片');
        delBtn.innerHTML = '&times;';
        delBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if(confirm('确定删除这张卡片吗？')) {
            await deleteCard(card.id);
            loadAndRenderCards();
          }
        });
        cardDiv.appendChild(delBtn);
      }

      // 名称显示，双击可编辑
      const nameDiv = document.createElement('div');
      nameDiv.className = 'card-name';
      // 支持关键词高亮，插入HTML
      nameDiv.innerHTML = highlightKeyword(card.name || '未命名', searchKeyword);
      nameDiv.title = '双击修改名称';

      if (isAdmin) {
        nameDiv.setAttribute('contenteditable', 'false');

        // 阻止点击名称时冒泡，避免触发图片放大
        nameDiv.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        // 双击开启编辑
        nameDiv.addEventListener('dblclick', () => {
          nameDiv.setAttribute('contenteditable', 'true');
          nameDiv.focus();

          // 选中全部文本，兼容多浏览器
          const range = document.createRange();
          range.selectNodeContents(nameDiv);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        });

        // 失去焦点保存
        nameDiv.addEventListener('blur', async () => {
          nameDiv.setAttribute('contenteditable', 'false');
          const newName = nameDiv.textContent.trim() || '未命名';
          // 更新显示并高亮
          nameDiv.innerHTML = highlightKeyword(newName, searchKeyword);
          await updateCardName(card.id, newName);
        });

        // 回车保存并阻止换行
        nameDiv.addEventListener('keydown', async (e) => {
          if(e.key === 'Enter') {
            e.preventDefault();
            nameDiv.blur();
          }
        });
      }

      cardDiv.appendChild(nameDiv);

      grid.appendChild(cardDiv);
    });
  }

  // --------------------
  // 加载并渲染卡片
  function loadAndRenderCards() {
    // 根据分类过滤卡片
    if(currentCategory === 'all') {
      currentCategoryCards = allCards.slice();
    } else {
      currentCategoryCards = allCards.filter(c => c.category === currentCategory);
    }

    // 过滤搜索关键词
    if(searchKeyword.trim() !== '') {
      const keyword = searchKeyword.trim().toLowerCase();
      currentCategoryCards = currentCategoryCards.filter(c => c.name.toLowerCase().includes(keyword));
    }

    renderCards(currentCategoryCards);
  }

  // --------------------
  // 添加新卡片
  async function addCards(files) {
    if (!files || files.length === 0) return;

    for(let file of files) {
      const imgData = await readFileAsDataURL(file);
      // 生成唯一ID
      const id = Date.now().toString() + Math.random().toString(16).slice(2);
      // 取当前分类，不能是all，all时默认新卡分类为"默认分类"
      let cat = currentCategory === 'all' ? '默认分类' : currentCategory;
      if(!categories.includes(cat)) {
        categories.push(cat);
        renderCategoryOptions();
      }
      allCards.push({
        id,
        name: '未命名',
        category: cat,
        imgData
      });
    }
    saveCards();
    loadAndRenderCategories();
    loadAndRenderCards();
  }

  // 读取文件为 DataURL
  function readFileAsDataURL(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
  }

  // 删除卡片
  async function deleteCard(id) {
    const idx = allCards.findIndex(c => c.id === id);
    if(idx !== -1) {
      allCards.splice(idx, 1);
      saveCards();
    }
  }

  // 更新卡片名称
  async function updateCardName(id, newName) {
    const card = allCards.find(c => c.id === id);
    if(card) {
      card.name = newName;
      saveCards();
    }
  }

  // 删除当前分类所有卡片
  deleteAllBtn.addEventListener('click', () => {
    if(currentCategory === 'all') {
      alert('请先选择具体分类');
      return;
    }
    if(confirm(`确定删除分类「${currentCategory}」的所有卡片吗？`)) {
      allCards = allCards.filter(c => c.category !== currentCategory);
      saveCards();
      loadAndRenderCategories();
      loadAndRenderCards();
    }
  });

  // 上传图片按钮
  uploadBtn.addEventListener('click', () => {
    uploadInput.click();
  });

  uploadInput.addEventListener('change', () => {
    if (!uploadInput.files) return;
    addCards(uploadInput.files);
    uploadInput.value = '';
  });

  // 搜索框输入事件
  searchInput.addEventListener('input', () => {
    searchKeyword = searchInput.value;
    loadAndRenderCards();
  });

  // --------------------
  // 弹窗逻辑
  function openModal(idx) {
    if (idx < 0 || idx >= currentCategoryCards.length) return;
    currentIndex = idx;
    modalImg.src = currentCategoryCards[currentIndex].imgData;
    modal.style.display = 'flex';
    modal.focus();
  }
  function closeModal() {
    modal.style.display = 'none';
  }
  function showPrev() {
    if (currentCategoryCards.length === 0) return;
    currentIndex = (currentIndex - 1 + currentCategoryCards.length) % currentCategoryCards.length;
    modalImg.src = currentCategoryCards[currentIndex].imgData;
  }
  function showNext() {
    if (currentCategoryCards.length === 0) return;
    currentIndex = (currentIndex + 1) % currentCategoryCards.length;
    modalImg.src = currentCategoryCards[currentIndex].imgData;
  }

  modalCloseBtn.addEventListener('click', closeModal);
  modalLeftArrow.addEventListener('click', showPrev);
  modalRightArrow.addEventListener('click', showNext);

  // 键盘导航
  window.addEventListener('keydown', (e) => {
    if(modal.style.display === 'flex') {
      if(e.key === 'ArrowLeft') {
        showPrev();
      } else if(e.key === 'ArrowRight') {
        showNext();
      } else if(e.key === 'Escape') {
        closeModal();
      }
    }
  });

  // 点击弹窗背景关闭
  modal.addEventListener('click', (e) => {
    if(e.target === modal) {
      closeModal();
    }
  });

  // 页面初始加载
  function renderCategoryOptions() {
    categorySelect.innerHTML = '';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat === 'all' ? '全部分类' : cat;
      categorySelect.appendChild(opt);
    });
  }

  function init() {
    // 先从 localStorage 载入所有分类卡片
    let storedCats = ['all'];
    // 读取 localStorage keys 识别分类
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key && key.startsWith('cards-')) {
        const cat = key.substring(6);
        if(cat !== 'all' && !storedCats.includes(cat)) storedCats.push(cat);
      }
    }
    categories = storedCats;

    // 载入卡片
    allCards = [];
    categories.forEach(cat => {
      const data = localStorage.getItem(`cards-${cat}`);
      if(data) {
        const cards = JSON.parse(data);
        cards.forEach(c => {
          if(!allCards.find(ac => ac.id === c.id)) {
            allCards.push(c);
          }
        });
      }
    });

    renderCategoryOptions();
    currentCategory = 'all';
    categorySelect.value = currentCategory;

    loadAndRenderCards();
  }

  init();

</script>
</body>
</html>