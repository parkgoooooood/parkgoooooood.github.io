<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>小卡展示（含管理员系统）</title>
<style>
  /* 重置与基础 */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: "Noto Sans SC", "Microsoft YaHei", sans-serif;
    background: #f9faff;
    margin: 20px;
    color: #222;
  }
  h1 {
    text-align: center;
    margin-bottom: 16px;
    color: #1a1a1a;
  }

  /* 按钮 */
  button {
    cursor: pointer;
    border: none;
    border-radius: 6px;
    background: #3a86ff;
    color: white;
    padding: 8px 16px;
    font-size: 14px;
    transition: background-color 0.3s ease;
  }
  button:hover,
  button:focus {
    background: #265dcf;
    outline: none;
  }
  button[disabled] {
    background: #b0c4ff;
    cursor: default;
  }

  /* 管理员登录按钮 */
  #adminLoginBtn,
  #adminAvatarBtn {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 1050;
    background: #3a86ff;
    padding: 6px 10px;
    border-radius: 30px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  #adminAvatarBtn {
    display: none;
    border-radius: 50%;
    padding: 0;
    width: 40px;
    height: 40px;
    overflow: hidden;
  }
  #adminAvatarBtn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* 登录面板 */
  #loginPanel {
    max-width: 320px;
    margin: 48px auto 24px;
    padding: 16px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 6px 12px rgb(0 0 0 / 0.1);
    text-align: center;
  }
  #loginPanel input {
    width: 100%;
    padding: 8px 12px;
    margin-bottom: 12px;
    font-size: 14px;
    border: 1.5px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.3s ease;
  }
  #loginPanel input:focus {
    border-color: #3a86ff;
    outline: none;
  }
  #loginPanel button {
    width: 100%;
    font-weight: 600;
  }

  /* 管理员面板 */
  #adminPanel {
    max-width: 900px;
    margin: 24px auto 40px;
    background: #fff;
    padding: 20px 24px;
    border-radius: 8px;
    box-shadow: 0 6px 12px rgb(0 0 0 / 0.1);
    display: none;
  }
  #adminPanel h2 {
    margin-top: 0;
    margin-bottom: 16px;
    color: #1a1a1a;
  }
  #adminPanel label {
    font-weight: 600;
    margin-right: 8px;
  }
  #adminPanel select,
  #adminPanel input[type="file"] {
    margin-right: 12px;
    vertical-align: middle;
  }
  #uploadBtn,
  #deleteAllBtn,
  #logoutBtn {
    margin-right: 12px;
  }

  /* 搜索框 */
  #searchInput {
    display: block;
    width: 300px;
    max-width: 90vw;
    margin: 0 auto 20px auto;
    padding: 10px 14px;
    font-size: 16px;
    border: 1.8px solid #ccc;
    border-radius: 8px;
    transition: border-color 0.3s ease;
  }
  #searchInput:focus {
    border-color: #3a86ff;
    outline: none;
  }

  /* 卡片网格 */
  #cardGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
    gap: 14px;
    max-width: 960px;
    margin: 0 auto 60px;
  }
  .card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.08);
    padding: 8px;
    position: relative;
    cursor: pointer;
    user-select: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: box-shadow 0.25s ease;
  }
  .card:hover,
  .card:focus-within {
    box-shadow: 0 6px 16px rgb(0 0 0 / 0.16);
  }
  .card img {
    width: 100%;
    height: 140px;
    object-fit: contain;
    border-radius: 6px;
    margin-bottom: 6px;
  }
  .card-name {
    width: 100%;
    font-weight: 600;
    font-size: 14px;
    line-height: 1.3;
    color: #222;
    user-select: text;
    overflow-wrap: break-word;
    word-break: break-word;
  }
  .card-name[contenteditable="true"] {
    border: 1.5px solid #3a86ff;
    padding: 4px 6px;
    border-radius: 6px;
    background: #eef5ff;
  }

  /* 删除按钮 */
  .delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255, 0, 0, 0.85);
    border-radius: 50%;
    border: none;
    width: 26px;
    height: 26px;
    font-weight: bold;
    font-size: 18px;
    line-height: 1;
    color: white;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  .delete-btn:hover,
  .delete-btn:focus {
    background: rgba(200, 0, 0, 0.95);
    outline: none;
  }

  /* 高亮搜索关键词 */
  .highlight {
    background-color: #fffa8b;
    color: #b37000;
    font-weight: 700;
    border-radius: 3px;
    padding: 0 3px;
  }

  /* 大图弹窗 */
  #modal {
    display: none;
    position: fixed;
    z-index: 2000;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }
  #modal img {
    max-width: 90vw;
    max-height: 80vh;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.8);
  }
  #modal .arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 48px;
    color: #eee;
    user-select: none;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    width: 56px;
    height: 56px;
    line-height: 56px;
    text-align: center;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #modal .arrow:hover,
  #modal .arrow:focus {
    background: rgba(0,0,0,0.6);
    outline: none;
  }
  #modal .arrow-left {
    left: 24px;
  }
  #modal .arrow-right {
    right: 24px;
  }
  #modal .close-btn {
    position: absolute;
    top: 24px;
    right: 24px;
    font-size: 36px;
    color: #eee;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
  }
  #modal .close-btn:hover,
  #modal .close-btn:focus {
    color: #fff;
    outline: none;
  }
</style>
</head>
<body>
<h1>小卡展示（含管理员系统）</h1>

<button id="adminLoginBtn" title="管理员登录" aria-haspopup="dialog" aria-controls="loginPanel">登录</button>
<button id="adminAvatarBtn" title="管理员菜单" aria-haspopup="true" aria-expanded="false" aria-label="管理员菜单" aria-controls="adminPanel">
  <img src="" alt="管理员头像" />
</button>

<div id="loginPanel" role="dialog" aria-modal="true" aria-labelledby="loginTitle" style="display:none;">
  <h2 id="loginTitle" style="text-align:center;">管理员登录</h2>
  <input type="text" id="adminUser" placeholder="用户名" autocomplete="username" aria-label="管理员用户名" />
  <input type="password" id="adminPass" placeholder="密码" autocomplete="current-password" aria-label="管理员密码" />
  <button id="loginSubmitBtn">登录</button>
</div>

<div id="adminPanel" role="region" aria-label="管理员面板" tabindex="-1" style="display:none;">
  <h2>管理员面板</h2>
  <label for="categorySelect">选择分类：</label>
  <select id="categorySelect" aria-controls="cardGrid" aria-label="选择卡片分类"></select>

  <input type="file" id="uploadInput" accept="image/*" multiple aria-label="上传图片" style="display:none;" />
  <button id="uploadBtn" title="上传图片">上传图片</button>
  <button id="deleteAllBtn" title="删除当前分类所有卡片">删除当前分类所有</button>
  <button id="logoutBtn" title="退出登录">退出登录</button>
</div>

<input id="searchInput" type="search" placeholder="搜索卡片名称..." aria-label="搜索卡片名称" />

<div id="cardGrid" class="grid" role="list" aria-live="polite" aria-atomic="true" aria-relevant="additions removals" tabindex="0"></div>

<div id="modal" role="dialog" aria-modal="true" aria-label="图片预览" tabindex="-1">
  <span class="arrow arrow-left" role="button" tabindex="0" aria-label="上一张图片">&#10094;</span>
  <img src="" alt="卡片大图" />
  <span class="arrow arrow-right" role="button" tabindex="0" aria-label="下一张图片">&#10095;</span>
  <span class="close-btn" role="button" tabindex="0" aria-label="关闭弹窗">&times;</span>
</div>

<script>
  const ADMIN_USERNAME = 'admin';
  const ADMIN_PASSWORD = '123456';

  let isAdmin = false;
  let categories = ['all'];
  let allCards = [];
  let currentCategory = 'all';
  let currentCategoryCards = [];
  let searchKeyword = '';
  let currentIndex = 0;

  // 元素引用
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminAvatarBtn = document.getElementById('adminAvatarBtn');
  const loginPanel = document.getElementById('loginPanel');
  const loginSubmitBtn = document.getElementById('loginSubmitBtn');
  const adminUserInput = document.getElementById('adminUser');
  const adminPassInput = document.getElementById('adminPass');
  const adminPanel = document.getElementById('adminPanel');
  const categorySelect = document.getElementById('categorySelect');
  const uploadInput = document.getElementById('uploadInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const deleteAllBtn = document.getElementById('deleteAllBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const searchInput = document.getElementById('searchInput');
  const cardGrid = document.getElementById('cardGrid');
  const modal = document.getElementById('modal');
  const modalImg = modal.querySelector('img');
  const modalCloseBtn = modal.querySelector('.close-btn');
  const modalLeftArrow = modal.querySelector('.arrow-left');
  const modalRightArrow = modal.querySelector('.arrow-right');

  // 显示登录面板
  function showLoginPanel(show) {
    loginPanel.style.display = show ? 'block' : 'none';
    adminLoginBtn.style.display = show ? 'none' : 'inline-flex';
    adminAvatarBtn.style.display = 'none';
    adminPanel.style.display = 'none';
  }

  // 登录按钮点击
  adminLoginBtn.addEventListener('click', () => {
    showLoginPanel(true);
    adminUserInput.focus();
  });

  // 管理员登录验证
  loginSubmitBtn.addEventListener('click', handleLogin);
  adminPassInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') handleLogin();
  });

  function handleLogin() {
    const user = adminUserInput.value.trim();
    const pass = adminPassInput.value.trim();
    if(user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
      isAdmin = true;
      showLoginPanel(false);
      adminAvatarBtn.style.display = 'inline-flex';
      adminAvatarBtn.querySelector('img').src = 'https://i.pravatar.cc/40?u=admin';
      adminLoginBtn.style.display = 'none';
      adminPanel.style.display = 'block';
      adminPanel.focus();
      loadAndRenderCategories();
      loadAndRenderCards();
      clearLoginInputs();
    } else {
      alert('用户名或密码错误');
      adminUserInput.focus();
    }
  }

  // 退出登录
  logoutBtn.addEventListener('click', () => {
    if(confirm('确定退出登录吗？')) {
      isAdmin = false;
      showLoginPanel(false);
      adminLoginBtn.style.display = 'inline-flex';
      adminAvatarBtn.style.display = 'none';
      adminPanel.style.display = 'none';
      clearData();
      loadAndRenderCards();
      searchKeyword = '';
      searchInput.value = '';
    }
  });

  // 管理员头像按钮切换面板显示
  adminAvatarBtn.addEventListener('click', () => {
    const isVisible = adminPanel.style.display === 'block';
    adminPanel.style.display = isVisible ? 'none' : 'block';
    adminAvatarBtn.setAttribute('aria-expanded', String(!isVisible));
    if(!isVisible) adminPanel.focus();
  });

  // 清除登录输入
  function clearLoginInputs() {
    adminUserInput.value = '';
    adminPassInput.value = '';
  }

  // 清除数据
  function clearData() {
    categories = ['all'];
    currentCategory = 'all';
    allCards = [];
  }

  // 本地存储数据键名
  const storagePrefix = 'cards-';

  // 保存所有分类卡片到 localStorage
  function saveCards() {
    categories.forEach(cat => {
      const cards = allCards.filter(c => c.category === cat);
      localStorage.setItem(storagePrefix + cat, JSON.stringify(cards));
    });
  }

  // 加载所有分类卡片
  function loadCardsFromStorage() {
    allCards = [];
    let storedCats = new Set(['all']);
    for(let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key && key.startsWith(storagePrefix)) {
        const cat = key.slice(storagePrefix.length);
        storedCats.add(cat);
        try {
          const cards = JSON.parse(localStorage.getItem(key));
          cards.forEach(c => {
            if(!allCards.find(ac => ac.id === c.id)) allCards.push(c);
          });
        } catch {}
      }
    }
    categories = Array.from(storedCats);
  }

  // 渲染分类选择框
  function renderCategoryOptions() {
    categorySelect.innerHTML = '';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat === 'all' ? '全部分类' : cat;
      categorySelect.appendChild(option);
    });
    categorySelect.value = currentCategory;
  }

  // 分类切换
  categorySelect.addEventListener('change', () => {
    currentCategory = categorySelect.value;
    loadAndRenderCards();
  });

  // 关键词高亮函数
  function highlightKeyword(text, keyword) {
    if (!keyword) return escapeHtml(text);
    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedKeyword})`, 'gi');
    return escapeHtml(text).replace(regex, '<span class="highlight">$1</span>');
  }

  // HTML 转义，防止XSS
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      switch (m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case '\'': return '&#39;';
        default: return m;
      }
    });
  }

  // 渲染卡片列表
  function renderCards(cards) {
    cardGrid.innerHTML = '';
    cards.forEach(card => {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.setAttribute('tabindex', '0');
      cardDiv.setAttribute('role', 'listitem');
      cardDiv.setAttribute('aria-label', `卡片：${card.name || '未命名'}`);

      // 图片
      const img = document.createElement('img');
      img.src = card.imgData;
      img.alt = card.name || '小卡图片';
      img.loading = 'lazy';
      cardDiv.appendChild(img);

      // 管理员删除按钮
      if (isAdmin) {
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.title = '删除此卡片';
        delBtn.setAttribute('aria-label', '删除此卡片');
        delBtn.innerHTML = '&times;';
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          if (confirm('确定删除这张卡片吗？')) {
            deleteCard(card.id);
          }
        });
        cardDiv.appendChild(delBtn);
      }

      // 名称显示，支持高亮和编辑
      const nameDiv = document.createElement('div');
      nameDiv.className = 'card-name';
      nameDiv.title = '双击修改名称';
      nameDiv.innerHTML = highlightKeyword(card.name || '未命名', searchKeyword);

      if (isAdmin) {
        nameDiv.setAttribute('contenteditable', 'false');
        // 点击阻止冒泡，避免图片放大
        nameDiv.addEventListener('click', e => e.stopPropagation());
        // 双击开启编辑
        nameDiv.addEventListener('dblclick', () => {
          nameDiv.setAttribute('contenteditable', 'true');
          nameDiv.focus();
          document.execCommand('selectAll', false, null);
        });
        // 失去焦点保存
        nameDiv.addEventListener('blur', async () => {
          nameDiv.setAttribute('contenteditable', 'false');
          let newName = nameDiv.textContent.trim() || '未命名';
          card.name = newName;
          saveCards();
          loadAndRenderCards();
        });
        // 回车保存并失去焦点
        nameDiv.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            nameDiv.blur();
          }
        });
      }
      cardDiv.appendChild(nameDiv);

      // 点击图片放大预览
      img.addEventListener('click', () => {
        currentCategoryCards = getCardsByCategoryAndSearch();
        currentIndex = currentCategoryCards.findIndex(c => c.id === card.id);
        if (currentIndex < 0) currentIndex = 0;
        openModal(currentIndex);
      });

      cardGrid.appendChild(cardDiv);
    });
  }

  // 获取当前分类和搜索过滤后的卡片
  function getCardsByCategoryAndSearch() {
    let filtered = [];
    if (currentCategory === 'all') {
      filtered = allCards.slice();
    } else {
      filtered = allCards.filter(c => c.category === currentCategory);
    }
    if (searchKeyword.trim()) {
      const kw = searchKeyword.trim().toLowerCase();
      filtered = filtered.filter(c => (c.name || '').toLowerCase().includes(kw));
    }
    return filtered;
  }

  // 加载并渲染卡片
  function loadAndRenderCards() {
    currentCategoryCards = getCardsByCategoryAndSearch();
    renderCards(currentCategoryCards);
  }

  // 上传按钮点击，触发文件选择
  uploadBtn.addEventListener('click', () => {
    uploadInput.value = '';
    uploadInput.click();
  });

  // 文件选择后处理上传
  uploadInput.addEventListener('change', () => {
    const files = Array.from(uploadInput.files);
    if (files.length === 0) return;

    const maxFileSizeMB = 5;
    const validImages = files.filter(f => {
      if (!f.type.startsWith('image/')) {
        alert(`文件 "${f.name}" 不是有效图片格式。`);
        return false;
      }
      if (f.size > maxFileSizeMB * 1024 * 1024) {
        alert(`文件 "${f.name}" 超过${maxFileSizeMB}MB限制。`);
        return false;
      }
      return true;
    });

    if (validImages.length === 0) return;

    // 依次读取文件并保存
    let promises = validImages.map(file => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const imgData = e.target.result;
          // 生成唯一ID
          const id = 'id-' + Date.now() + '-' + Math.random().toString(16).slice(2);
          allCards.push({
            id,
            name: file.name.replace(/\.[^.]+$/, ''),
            imgData,
            category: currentCategory === 'all' ? '默认分类' : currentCategory
          });
          resolve();
        };
        reader.readAsDataURL(file);
      });
    });

    Promise.all(promises).then(() => {
      if (!categories.includes(currentCategory) && currentCategory !== 'all') {
        categories.push(currentCategory);
      }
      saveCards();
      loadAndRenderCategories();
      loadAndRenderCards();
      alert('上传成功！');
    });
  });

  // 删除单个卡片
  function deleteCard(cardId) {
    allCards = allCards.filter(c => c.id !== cardId);
    saveCards();
    loadAndRenderCards();
  }

  // 删除当前分类所有卡片
  deleteAllBtn.addEventListener('click', () => {
    if (currentCategory === 'all') {
      if (!confirm('您确定要删除所有分类的所有卡片吗？此操作不可恢复！')) return;
      allCards = [];
    } else {
      if (!confirm(`您确定要删除分类 "${currentCategory}" 的所有卡片吗？此操作不可恢复！`)) return;
      allCards = allCards.filter(c => c.category !== currentCategory);
    }
    saveCards();
    loadAndRenderCards();
  });

  // 加载分类和渲染分类选项
  function loadAndRenderCategories() {
    // 从卡片中提取分类，自动加上'all'
    const cats = new Set(['all']);
    allCards.forEach(c => {
      if (c.category && c.category.trim()) cats.add(c.category);
    });
    categories = Array.from(cats);
    if (!categories.includes(currentCategory)) currentCategory = 'all';
    renderCategoryOptions();
  }

  // 搜索输入
  searchInput.addEventListener('input', e => {
    searchKeyword = e.target.value;
    loadAndRenderCards();
  });

  // 大图弹窗控制
  function openModal(index) {
    if (index < 0 || index >= currentCategoryCards.length) return;
    currentIndex = index;
    modalImg.src = currentCategoryCards[currentIndex].imgData;
    modalImg.alt = currentCategoryCards[currentIndex].name || '卡片大图';
    modal.style.display = 'flex';
    modal.focus();
  }
  function closeModal() {
    modal.style.display = 'none';
    modalImg.src = '';
  }
  function showPrev() {
    currentIndex = (currentIndex - 1 + currentCategoryCards.length) % currentCategoryCards.length;
    openModal(currentIndex);
  }
  function showNext() {
    currentIndex = (currentIndex + 1) % currentCategoryCards.length;
    openModal(currentIndex);
  }

  // 弹窗事件绑定
  modalCloseBtn.addEventListener('click', closeModal);
  modalLeftArrow.addEventListener('click', showPrev);
  modalRightArrow.addEventListener('click', showNext);

  // 键盘操作弹窗
  modal.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') showPrev();
    if (e.key === 'ArrowRight') showNext();
  });

  // 点击弹窗外关闭
  modal.addEventListener('click', e => {
    if (e.target === modal) closeModal();
  });

  // 初始化加载数据
  function init() {
    loadCardsFromStorage();
    loadAndRenderCategories();
    loadAndRenderCards();
  }

  init();

</script>
</body>
</html>