<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>小卡管理系统</title>
  <link href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .hidden { display: none; }
    img { max-width: 100px; margin: 5px; cursor: pointer; }
    #categories button { margin: 5px; }
    #preview { max-width: 100%; }
    .card { display: inline-block; text-align: center; margin: 10px; }
    .card-name { font-size: 14px; margin-top: 5px; }
  </style>
</head>
<body>

  <h2>小卡展示系统</h2>

  <button onclick="showAdmin()">管理员登录</button>

  <div id="adminLogin" class="hidden">
    <input type="password" id="adminPass" placeholder="请输入密码">
    <button onclick="loginAdmin()">确认</button>
  </div>

  <div id="adminPanel" class="hidden">
    <select id="categorySelect">
      <option value="9.9卡池">9.9卡池</option>
      <option value="15.9卡池">15.9卡池</option>
      <option value="星光卡">星光卡</option>
      <option value="25.9吒卡池">25.9吒卡池</option>
      <option value="29.9吒卡池">29.9吒卡池</option>
      <option value="金冬天卡池">金冬天卡池</option>
      <option value="柳智敏卡池">柳智敏卡池</option>
      <option value="宁艺卓卡池">宁艺卓卡池</option>
      <option value="吉赛尔卡池">吉赛尔卡池</option>
      <option value="金智秀卡池">金智秀卡池</option>
      <option value="lisa卡池">lisa卡池</option>
      <option value="Jennie卡池">Jennie卡池</option>
      <option value="rose卡池">rose卡池</option>
      <option value="宝怪卡池">宝怪卡池</option>
      <option value="芙卡池">芙卡池</option>
    </select>
    <input type="file" id="fileInput">
    <input type="text" id="imageName" placeholder="图片名称">
    <button onclick="clearCategory()">清空分类</button>
  </div>

  <div id="cropContainer" class="hidden">
    <h3>裁剪图片</h3>
    <img id="cropImage">
    <button onclick="saveCropped()">完成裁剪</button>
  </div>

  <div id="categories"></div>

  <script src="https://unpkg.com/cropperjs"></script>
  <script>
    let isAdmin = false;
    let cropper;
    let currentFile;
    let currentCategory = '';
    let db;

    const request = indexedDB.open("CardDB", 1);
    request.onerror = e => alert("数据库出错");
    request.onsuccess = e => {
      db = e.target.result;
      loadAllCategories();
    };
    request.onupgradeneeded = e => {
      db = e.target.result;
      db.createObjectStore("cards", { keyPath: "id", autoIncrement: true });
    };

    function showAdmin() {
      document.getElementById("adminLogin").classList.remove("hidden");
    }

    function loginAdmin() {
      const pass = document.getElementById("adminPass").value;
      if (pass === "123456") {
        isAdmin = true;
        document.getElementById("adminPanel").classList.remove("hidden");
        document.getElementById("adminLogin").classList.add("hidden");
      } else {
        alert("密码错误");
      }
    }

    document.getElementById("fileInput").addEventListener("change", e => {
      currentFile = e.target.files[0];
      if (!currentFile) return;
      const reader = new FileReader();
      reader.onload = () => {
        const img = document.getElementById("cropImage");
        img.src = reader.result;
        document.getElementById("cropContainer").classList.remove("hidden");
        if (cropper) cropper.destroy();
        cropper = new Cropper(img, { aspectRatio: 1 });
      };
      reader.readAsDataURL(currentFile);
    });

    function saveCropped() {
      const name = document.getElementById("imageName").value;
      if (!name) return alert("请输入图片名称");
      const category = document.getElementById("categorySelect").value;
      cropper.getCroppedCanvas().toBlob(blob => {
        const reader = new FileReader();
        reader.onload = () => {
          const transaction = db.transaction(["cards"], "readwrite");
          const store = transaction.objectStore("cards");
          store.add({ data: reader.result, category, name });
          loadCategory(category);
          document.getElementById("cropContainer").classList.add("hidden");
          document.getElementById("imageName").value = "";
        };
        reader.readAsDataURL(blob);
      });
    }

    function loadAllCategories() {
      const categories = [...document.getElementById("categorySelect").options].map(o => o.value);
      categories.forEach(loadCategory);
    }

    function loadCategory(category) {
      const transaction = db.transaction(["cards"], "readonly");
      const store = transaction.objectStore("cards");
      const request = store.getAll();
      request.onsuccess = () => {
        const container = document.getElementById("categories");
        let html = `<h3>${category}</h3>`;
        request.result.forEach(card => {
          if (card.category === category) {
            html += `
              <div class="card">
                <img src="${card.data}" onclick="viewImage('${card.data}')">
                <div class="card-name">${card.name}</div>
                ${isAdmin ? `<button onclick="deleteCard(${card.id}, '${category}')">删除</button>` : ""}
              </div>`;
          }
        });
        document.getElementById("categories").insertAdjacentHTML("beforeend", `<div id="cat-${category}">${html}</div>`);
      };
    }

    function clearCategory() {
      const category = document.getElementById("categorySelect").value;
      const transaction = db.transaction(["cards"], "readwrite");
      const store = transaction.objectStore("cards");
      const request = store.getAll();
      request.onsuccess = () => {
        request.result.forEach(card => {
          if (card.category === category) store.delete(card.id);
        });
        document.getElementById("cat-" + category).remove();
      };
    }

    function deleteCard(id, category) {
      const transaction = db.transaction(["cards"], "readwrite");
      transaction.objectStore("cards").delete(id);
      document.getElementById("cat-" + category).remove();
      loadCategory(category);
    }

    function viewImage(url) {
      const win = window.open();
      win.document.write(`<img src="${url}" style="max-width:100%">`);
    }
  </script>

</body>
</html>