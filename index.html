<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>小卡展示系统</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f2f2f2;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
    }
    #cardGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    .card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      cursor: pointer;
    }
    .card-name {
      font-size: 12px;
      margin-top: 6px;
      text-align: center;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .card-name[contenteditable="true"] {
      border-bottom: 1px dashed #aaa;
    }
    .delete-btn {
      position: absolute;
      top: 4px;
      right: 6px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 999;
    }
    #modal img {
      max-width: 90vw;
      max-height: 80vh;
      border-radius: 6px;
    }
    .modal-nav {
      color: white;
      font-size: 40px;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      user-select: none;
    }
    #modal .left { left: 10px; }
    #modal .right { right: 10px; }
    #closeModal {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 28px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>韩娱小卡展示</h1>

<div id="controls">
  <input type="file" id="uploadInput" multiple accept="image/*" style="display:none">
  <select id="categorySelect">
    <option value="全部">全部</option>
  </select>
  <button id="uploadBtn" style="display:none">上传卡片</button>
  <button id="deleteAllBtn" style="display:none">删除该分类所有卡片</button>
  <button id="loginBtn">管理员登录</button>
  <button id="logoutBtn" style="display:none">退出登录</button>
</div>

<div id="cardGrid"></div>

<!-- 大图预览模态框 -->
<div id="modal">
  <span id="closeModal">✕</span>
  <span class="modal-nav left">‹</span>
  <img id="modalImg" src="" />
  <span class="modal-nav right">›</span>
</div>

<script>
let db, isAdmin = false, currentCategory = "全部", currentIndex = 0, currentCards = [];

const uploadInput = document.getElementById("uploadInput");
const categorySelect = document.getElementById("categorySelect");
const uploadBtn = document.getElementById("uploadBtn");
const deleteAllBtn = document.getElementById("deleteAllBtn");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const cardGrid = document.getElementById("cardGrid");

const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");
const closeModalBtn = document.getElementById("closeModal");
const leftNav = modal.querySelector(".left");
const rightNav = modal.querySelector(".right");

openDB();

categorySelect.addEventListener("change", () => {
  currentCategory = categorySelect.value;
  renderCards(currentCategory);
});

uploadBtn.addEventListener("click", () => uploadInput.click());
uploadInput.addEventListener("change", handleUpload);

deleteAllBtn.addEventListener("click", async () => {
  if (confirm("确定删除该分类所有卡片吗？")) {
    await deleteCategory(currentCategory);
    renderCards(currentCategory);
  }
});

loginBtn.addEventListener("click", () => {
  const pwd = prompt("请输入管理员密码：");
  if (pwd === "123456") {
    isAdmin = true;
    uploadBtn.style.display = deleteAllBtn.style.display = logoutBtn.style.display = "inline-block";
    loginBtn.style.display = "none";
  } else {
    alert("密码错误！");
  }
});

logoutBtn.addEventListener("click", () => {
  isAdmin = false;
  uploadBtn.style.display = deleteAllBtn.style.display = logoutBtn.style.display = "none";
  loginBtn.style.display = "inline-block";
});

closeModalBtn.onclick = () => modal.style.display = "none";
leftNav.onclick = () => { if (currentIndex > 0) { currentIndex--; updateModal(); } };
rightNav.onclick = () => { if (currentIndex < currentCards.length - 1) { currentIndex++; updateModal(); } };

function openModal(index) {
  currentIndex = index;
  updateModal();
  modal.style.display = "flex";
}

function updateModal() {
  modalImg.src = currentCards[currentIndex].image;
}

async function openDB() {
  const request = indexedDB.open("cardDB", 1);
  request.onerror = () => alert("打开数据库失败！");
  request.onsuccess = () => {
    db = request.result;
    renderCards(currentCategory);
    loadCategories();
  };
  request.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("cards", { keyPath: "id" });
  };
}

function addCard(card) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("cards", "readwrite");
    const store = tx.objectStore("cards");
    store.add(card);
    tx.oncomplete = resolve;
    tx.onerror = reject;
  });
}

function getCards() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("cards", "readonly");
    const store = tx.objectStore("cards");
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = reject;
  });
}

function deleteCard(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("cards", "readwrite");
    tx.objectStore("cards").delete(id);
    tx.oncomplete = resolve;
    tx.onerror = reject;
  });
}

function deleteCategory(category) {
  return getCards().then(cards => {
    const tx = db.transaction("cards", "readwrite");
    const store = tx.objectStore("cards");
    cards.forEach(card => {
      if (card.category === category) store.delete(card.id);
    });
  });
}

async function renderCards(category) {
  const cards = await getCards();
  currentCards = cards.filter(c => category === "全部" || c.category === category);
  cardGrid.innerHTML = "";
  currentCards.forEach((card, index) => {
    const div = document.createElement("div");
    div.className = "card";

    const img = document.createElement("img");
    img.src = card.image;
    img.alt = card.name || "";
    img.onclick = () => openModal(index);
    div.appendChild(img);

    const name = document.createElement("div");
    name.className = "card-name";
    name.textContent = card.name || "";
    if (isAdmin) {
      name.contentEditable = true;
      name.title = "点击修改名称，回车保存";
      name.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          card.name = name.textContent;
          const tx = db.transaction("cards", "readwrite");
          tx.objectStore("cards").put(card);
        }
      });
    }
    div.appendChild(name);

    if (isAdmin) {
      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "×";
      delBtn.onclick = async e => {
        e.stopPropagation();
        if (confirm("删除这张卡片？")) {
          await deleteCard(card.id);
          renderCards(category);
        }
      };
      div.appendChild(delBtn);
    }

    cardGrid.appendChild(div);
  });
}

function loadCategories() {
  getCards().then(cards => {
    const cats = new Set(cards.map(c => c.category));
    categorySelect.innerHTML = '<option value="全部">全部</option>';
    cats.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      categorySelect.appendChild(opt);
    });
  });
}

function fileToBase64(file) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

async function handleUpload(e) {
  const files = e.target.files;
  const category = prompt("请输入该批卡片所属分类：") || "未分类";
  for (const file of files) {
    const base64 = await fileToBase64(file);
    const card = {
      id: Date.now() + Math.random(),
      image: base64,
      category,
      name: file.name
    };
    await addCard(card);
  }
  uploadInput.value = "";
  renderCards(currentCategory);
  loadCategories();
}
</script>
</body>
</html>